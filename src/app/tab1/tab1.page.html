<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>Panel de Administrador</ion-title>
    <ion-button slot="end" color="danger" (click)="logout()">
      <ion-icon slot="icon-only" name="log-out"></ion-icon>
    </ion-button>
  </ion-toolbar>

  <ion-toolbar>
    <ion-searchbar
      animated="true"
      placeholder="Buscar por correo del medidor..."
      [(ngModel)]="searchTerm"
      (ionInput)="buscarLecturas($event)"
      (ionClear)="limpiarBusqueda()"
      showClearButton="always"
      debounce="300"
    ></ion-searchbar>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="refrescarLecturas($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="content-wrapper ion-padding">
    <ion-card class="stats-card">
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12">
              <ion-text color="primary">
                <h2>
                  <strong>
                    {{ searchTerm ? 'Resultados: ' + lecturasFiltradas.length : 'Total de Registros: ' + lecturas.length }}
                  </strong>
                </h2>
              </ion-text>
              <ion-text color="medium" *ngIf="searchTerm">
                <p>Buscando: "{{ searchTerm }}"</p>
              </ion-text>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="lecturasFiltradas.length === 0 && !searchTerm" class="empty-state">
      <ion-card-content class="ion-text-center">
        <ion-icon name="document-text-outline" size="large" color="medium"></ion-icon>
        <h2>No hay registros disponibles</h2>
        <p>Los registros de los medidores aparecerán aquí</p>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="lecturasFiltradas.length === 0 && searchTerm" class="empty-state">
      <ion-card-content class="ion-text-center">
        <ion-icon name="search-outline" size="large" color="warning"></ion-icon>
        <h2>No se encontraron resultados</h2>
        <p>No hay registros que coincidan con "{{ searchTerm }}"</p>
        <ion-button fill="outline" (click)="limpiarBusqueda()">
          Mostrar todos los registros
        </ion-button>
      </ion-card-content>
    </ion-card>

    <ion-card *ngFor="let lectura of lecturasFiltradas" class="lectura-card">
      <ion-card-header>
        <ion-grid>
          <ion-row>
            <ion-col size="12">
              <ion-badge color="primary">
                <ion-icon name="person-outline"></ion-icon>
                {{ lectura.profiles?.email || 'Usuario desconocido' }}
              </ion-badge>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-header>

      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="6">
              <div class="foto-container">
                <h4>Foto del Medidor</h4>
                <ion-img [src]="lectura.foto_medidor" alt="Medidor"></ion-img>
              </div>
            </ion-col>
            <ion-col size="6">
              <div class="foto-container">
                <h4>Foto de la Fachada</h4>
                <ion-img [src]="lectura.foto_fachada" alt="Fachada"></ion-img>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>

        <ion-item lines="none">
          <ion-label>
            <h3><strong>Valor del Medidor</strong></h3>
            <p>{{ lectura.valor_medidor }} kWh</p>
          </ion-label>
        </ion-item>

        <ion-item lines="none" *ngIf="lectura.observaciones">
          <ion-label>
            <h3><strong>Observaciones</strong></h3>
            <p>{{ lectura.observaciones }}</p>
          </ion-label>
        </ion-item>

        <ion-item lines="none" button (click)="abrirEnMaps(lectura.latitud, lectura.longitud)">
          <ion-icon name="location-outline" slot="start" color="danger"></ion-icon>
          <ion-label>
            <h3><strong>Ubicación GPS</strong></h3>
            <p>Lat: {{ lectura.latitud?.toFixed(6) }}</p>
            <p>Lng: {{ lectura.longitud?.toFixed(6) }}</p>
          </ion-label>
          <ion-badge slot="end" color="danger">Ver en Mapa</ion-badge>
        </ion-item>

        <ion-item lines="none">
          <ion-icon name="calendar-outline" slot="start" color="medium"></ion-icon>
          <ion-label>
            <p>{{ formatearFecha(lectura.created_at) }}</p>
          </ion-label>
        </ion-item>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>